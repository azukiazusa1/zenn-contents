---
title: "Nest.js + TypeORMã§GraphQL"
emoji: "ğŸ¡"
type: "tech"
topics: ["graphql", "typescript", "nestjs", "typeorm"]
published: true
---

# Nest.jsã¨ã¯

Nest.js ã¯ Node.js ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚ã‚Šã€TypeScript ã‚’å®Œå…¨ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ Express ã‚’ã‚³ã‚¢ã¨ã—ã¦å‹•ä½œã—ã¾ã™ãŒã€Fastify ã‚’ã‚³ã‚¢ã¨ã—ã¦å‹•ä½œã•ã›ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

https://docs.nestjs.com/

Nest.js ã¨ç‰¹å¾´ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚

- Angular é¢¨ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ DI ã®æ©Ÿæ§‹ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹
- ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã«ã‚ˆã‚‹é–¢å¿ƒã®åˆ†é›¢

# Nest.jsãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

æœ€åˆã«ã€Nest CLI ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
Nest CLI ã¯ Anguar CLI ã¨ã‚ˆãä¼¼ã¦ãŠã‚Šã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ–°è¦ä½œæˆã‚„ serviceã€controllerã€model ãªã©ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ§‹æˆè¦ç´ ã®ä½œæˆãªã©ã‚’æ‰‹åŠ©ã‘ã—ã¦ãã‚Œã¾ã™ã€‚

```sh
$ npm i -g @nestjs/cli
```

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ãŸã‚‰ã€`nest new` ã‚³ãƒãƒ³ãƒ‰ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã§ãã¾ã™ã€‚

```sh
nest new nest-sample-app
```

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¦ã€`start:dev` ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã£ã¦é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã—ã¾ã™ã€‚

```sh
cd nest-sample-app
npm run start:dev
```

http://localhost:3000 ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€`Hello World!` ã¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/j1ybjkpivfu6jg8d935hqn4cn74f)


# GraphQLã®å°å…¥

Nest.js ã«ã‚ˆã‚‹ GraphQL ã®é–‹ç™ºã§ã¯ã€ä»¥ä¸‹ã® 2 ã¤ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚

- ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ
- ã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ

ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯ã€ãƒ‡ã‚³ãƒ¬ãƒ¼ãƒˆã¨ TypeScript ã®ã‚¯ãƒ©ã‚¹ã‚’ç”¨ã„ã¦ä½œæˆã—ã¾ã™ã€‚GraphQL ã®ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã¯è‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã¾ã™ã€‚
åå¯¾ã«ã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯ GraphQK ã®ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã«åŸºã¥ã„ã¦ TypeScript å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•çš„ã«ä½œæˆã—ã¾ã™ã€‚

ä»Šå›ã¯ã€ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æ¡ç”¨ã—ã¾ã™ã€‚

## GraphQLã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

ã¯ã˜ã‚ã«ã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```sh
npm i @nestjs/graphql graphql-tools graphql apollo-server-express
```

æ¬¡ã«ã€`app.module.ts` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã— `GraphQLModule` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚

```diff ts:app.module.ts
import { Module } from '@nestjs/common';
import { AppController } from './app.controller';
import { AppService } from './app.service';
+ import { GraphQLModule } from '@nestjs/graphql';
+ import { join } from 'path';

@Module({
- imports: [],
+ imports: [
+   GraphQLModule.forRoot({
+     autoSchemaFile: join(process.cwd(), 'src/schema.gql'),
+   }),
+  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

`GraphQLModule` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®è¨­å®šã¯ã€`forRoot()` ãƒ¡ã‚½ãƒƒãƒ‰ã‹ã‚‰æ¸¡ã—ã¾ã™ã€‚`autoSchemaFile` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚ˆã£ã¦ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’ã—ã¦ã„ã—ã¾ã™ã€‚
ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æ¡ç”¨ã—ã¦ã„ã‚‹ã®ã§ã€ã“ã‚Œã¯å¾Œã»ã©è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

## ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ

ã¾ãšã¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã£ã¦ `books` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```sh
$ nest generate module books
CREATE src/books/books.module.ts (82 bytes)
UPDATE src/app.module.ts (496 bytes)
```

## ãƒ¢ãƒ‡ãƒ«ã®ä½œæˆ

ç¶šã„ã¦ãƒ¢ãƒ‡ãƒ«ã®ä½œæˆã§ã™ã€‚

```sh
$ nest generate class books/book
CREATE src/books/book.spec.ts (139 bytes)
CREATE src/books/book.ts (21 bytes)
```

ä½œæˆã—ãŸãƒ¢ãƒ‡ãƒ«ã« GraphQL ã®ã‚¹ã‚­ãƒ¼ãƒã¨å¯¾å¿œã•ã›ã¾ã™ã€‚
ãƒ¢ãƒ‡ãƒ«ã‚¯ãƒ©ã‚¹ã«ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’ä»˜ä¸ã—ã¦ãã¾ã™ã€‚

```ts:src/books/book.ts
import { Field, ID, ObjectType, Int } from '@nestjs/graphql';

@ObjectType()
export class Book {
  @Field((type) => ID)
  id: number;

  @Field()
  title: string;

  @Field()
  author: string;

  @Field((type) => Int)
  price: number;

  @Field()
  createdAt: Date;
}
```

## ãƒªã‚¾ãƒ«ãƒ¼ãƒã®ä½œæˆ

æ¬¡ã«ã€ãƒªã‚¾ãƒ«ãƒ¼ãƒã‚’ä½œæˆã—ã¾ã™ã€‚
ãƒªã‚¾ãƒ«ãƒ¼ãƒã¯ã€GraphQL ã®ã‚¯ã‚¨ãƒªãƒ»ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–ãªã©ã®æ“ä½œã‚’å®Ÿéš›ã«ã©ã®ã‚ˆã†ã«è¡Œã†ã‹å®Ÿè£…ã—ã¾ã™ã€‚

ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ã€ãƒªã‚¾ãƒ«ãƒ¼ãƒã‚’ä½œæˆã—ã¾ã™ã€‚

```sh
$ nest generate resolver books
CREATE src/books/books.resolver.spec.ts (463 bytes)
CREATE src/books/books.resolver.ts (87 bytes)
UPDATE src/books/books.module.ts (224 bytes)
```

ãƒªã‚¾ãƒ«ãƒ¼ãƒã®å®Ÿè£…ã§ã™ã€‚
 å®Ÿéš›ã®å‡¦ç†ã¯å¾Œã‹ã‚‰ä½œæˆã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã®å®Ÿè£…ã«ä»»ã›ã¾ã™ã€‚ã‚µãƒ¼ãƒ“ã‚¹ã¯ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦å¤–éƒ¨ã‹ã‚‰æ³¨å…¥ã—ã¾ã™ã€‚
 
 
```ts: src/books/books.resolver.ts
import { NotFoundException } from '@nestjs/common';
import { Args, Int, Mutation, Query, Resolver } from '@nestjs/graphql';
import { Book } from './book';
import { BooksService } from './books.service';
import { newBookInput } from './dto/newBook.input';

@Resolver((of) => Book)
export class BooksResolver {
  constructor(private booksService: BooksService) {}

  @Query((returns) => [Book])
  books(): Promise<Book[]> {
    return this.booksService.findAll();
  }

  @Query((returns) => Book)
  async getBook(@Args({ name: 'id', type: () => Int }) id: number) {
    const book = await this.booksService.findOneById(id);
    if (!book) {
      throw new NotFoundException(id);
    }
    return book;
  }

  @Mutation((returns) => Book)
  addBook(@Args('newBook') newBook: newBookInput): Promise<Book> {
    return this.booksService.create(newBook);
  }

  @Mutation((returns) => Boolean)
  async removeBook(@Args({ name: 'id', type: () => Int }) id: number) {
    return this.booksService.remove(id);
  }
}
```
 
## DTOã®ä½œæˆ

NestJS ã® DTO(Data Transfer Object)ã¯ Request Payload(body)ã®å‹å®šç¾©ã‚’è¡Œã†ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚å‹å®šç¾©ã‚’ã™ã‚‹ã¨åŒæ™‚ã«ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å«ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚

ã¾ãšã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã«å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```sh
npm i class-validator class-transformer
```
 
`src/books` ãƒ•ã‚©ãƒ«ãƒ€é…ä¸‹ã« `dto/newBook.input.ts` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
 
 ```ts:src/books/dto/newBook.input.ts
import { Field, InputType, Int } from '@nestjs/graphql';
import { Max, MaxLength, Min } from 'class-validator';

@InputType()
export class NewBookInput {
  @Field()
  @MaxLength(30)
  title: string;

  @Field((type) => Int)
  @Min(0)
  @Max(9999)
  price: number;

  @Field((type) => [String])
  author: string;
}
```

`@InputType()` ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ã§ã€GraphQL ã® `input types` ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚
ã•ã‚Œã«ã€`class-validator` ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã«ã‚ˆã£ã¦ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

https://github.com/typestack/class-validator

ç¶šã„ã¦ã€`ValidationPipe` ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã™ã€‚
Nest.js ã§ã¯[Pipes](https://docs.nestjs.com/pipes)ã¨å‘¼ã°ã‚Œã‚‹ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã«ã‚ˆã£ã¦å…¥åŠ›ã‚’å—ã‘å–ã‚‹å‰ï¼ˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚„ãƒªã‚¾ãƒ«ãƒ¼ãƒã®å‡¦ç†ã«åˆ°é”ã™ã‚‹å‰ã«ï¼‰å¤‰æ›å‡¦ç†ã‚„ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚

`ValidationPipe` ã¯ Nest.js ã§ã‚ã‚‰ã‹ã˜ã‚åˆ©ç”¨ã§ãã‚‹ãƒ“ãƒ«ãƒ‰ã‚¤ãƒ³ãƒ‘ã‚¤ãƒ—ã® 1 ã¤ã§ã™ã€‚

`src/main.ts` ã‚’ç·¨é›†ã—ã¾ã™ã€‚
```diff ts:src/main.ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
+ import { ValidationPipe } from '@nestjs/common';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
+  app.useGlobalPipes(new ValidationPipe());
  await app.listen(3000);
}
bootstrap();
```


## ã‚µãƒ¼ãƒ“ã‚¹ã®ä½œæˆ

ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

```sh
$ nest generate service books
CREATE src/books/books.service.spec.ts (453 bytes)
CREATE src/books/books.service.ts (89 bytes)
UPDATE src/books/books.module.ts (159 bytes)
```

ã‚µãƒ¼ãƒ“ã‚¹ã«ã¯å®Ÿéš›ã®ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¨˜è¿°ã—ã¾ã™ã€‚
ã²ã¨ã¾ãšã¯ãƒ¢ãƒƒã‚¯ã®å‡¦ç†ã‚’å®Ÿè£…ã—ã¦ãŠãã¾ã™ã€‚

```ts:src/books/books.service.ts
import { Injectable } from '@nestjs/common';
import { Book } from './book';
import { newBookInput } from './dto/newBook.input';

let books = [
  {
    id: 1,
    title: 'test 1',
    author: 'Joe',
    price: 1000,
    createdAt: new Date(),
  },
  {
    id: 2,
    title: 'test 2',
    author: 'Maria',
    price: 2000,
    createdAt: new Date(),
  },
  {
    id: 3,
    title: 'test 3',
    author: 'Smith',
    price: 3000,
    createdAt: new Date(),
  },
] as Book[];

@Injectable()
export class BooksService {
  findAll(): Promise<Book[]> {
    return Promise.resolve(books);
  }

  findOneById(id: number): Promise<Book> {
    const book = books.find((book) => book.id === id);
    return Promise.resolve(book);
  }

  create(data: newBookInput): Promise<Book> {
    const book: Book = {
      ...data,
      id: Date.now(),
      createdAt: new Date(),
    };
    books.push(book);

    return Promise.resolve(book);
  }

  async remove(id: number): Promise<boolean> {
    books = books.filter((book) => book.id !== id);
    return true;
  }
}
```

ã“ã“ã¾ã§ã®å®Ÿè£…ã‚’ã„ã£ãŸã‚“ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
http://localhost:3000/graphql ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ GraphQL ã®ãƒ—ãƒ¬ã‚¤ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã“ã“ã§ä½œæˆã—ãŸ GraphQL ã‚’è‡ªç”±ã«è©¦ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

`books` ã‚¯ã‚¨ãƒªã‚’è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
![](https://storage.googleapis.com/zenn-user-upload/bvxi01963gpbus5kq3latnwtljgk)


# TypeORMã®å°å…¥

æ¬¡ã«ã€ãƒ¢ãƒƒã‚¯ã§å®Ÿè£…ã—ã¦ã„ãŸå‡¦ç†ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚ˆã‚‹å®Ÿè£…ã«ç½®ãæ›ãˆã¦ã„ãã¾ã™ã€‚
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã¯ MySQL ã‚’ã€ORM ã«ã¯ TypeORM ã‚’æ¡ç”¨ã—ã¾ã™ã€‚

https://typeorm.io/#/

TypeORM ã¨ã¯ã€åå‰é€šã‚Š TypeScript ã¨è¦ªå’Œæ€§ã®é«˜ã„ ORM ã§ã‚ã‚Šãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’ç”¨ã„ã¦ãƒ¢ãƒ‡ãƒ«ã‚’è¡¨ç¾ã—ã¾ã™ã€‚

## TypeORMã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

ã¾ãšã¯ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ã™ã€‚

```sh
npm install --save @nestjs/typeorm typeorm mysql2
```

MySQL ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¾ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã‚Š Docekr ã§ç’°å¢ƒæ§‹ç¯‰ãªã©ãŒå¿…è¦ã§ã™ã€‚
ã“ã®ä¾‹ã§ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸ MySQL ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```sh
$ brew install mysql # Homebrewã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
$ mysql --version # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèª
$ mysql  Ver 8.0.22 for osx10.14 on x86_64 (Homebrew)
$ mysql.server start --skip-grant-tables # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç„¡ã—ã§ãƒ­ã‚°ã‚¤ãƒ³
$ mysql -uroot # rootã§ãƒ­ã‚°ã‚¤ãƒ³
```

å‚è€ƒï¼š
https://qiita.com/fuwamaki/items/194c2a82bd6865f26045

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¦ãŠãã¾ã™ã€‚

```sh
mysql> create database nest_sample_app;
Query OK, 1 row affected (0.10 sec)
```

`app.module.ts` ã‚’ä¿®æ­£ã—ã¦ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã®æ¥ç¶šã‚’è¡Œã„ã¾ã™ã€‚

```diff ts:src/app.module.ts
import { Module } from '@nestjs/common';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { GraphQLModule } from '@nestjs/graphql';
import { join } from 'path';
import { BooksModule } from './books/books.module';
+ import { TypeOrmModule } from '@nestjs/typeorm';

@Module({
  imports: [
    GraphQLModule.forRoot({
      autoSchemaFile: join(process.cwd(), 'src/schema.gql'),
    }),
+     TypeOrmModule.forRoot({
+       type: 'mysql',
+       host: 'localhost',
+       port: 3306,
+       username: 'root',
+       password: '',
+       database: 'nest_sample_app',
+       entities: [],
+       synchronize: true,
+     }),
    BooksModule,
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

`synchronize` ã‚’ `true` ã¨ã™ã‚‹ã¨ TypeORM ã¯è‡ªå‹•ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

## ãƒ¢ãƒ‡ãƒ«ã®ä½œæˆ

ãƒ¢ãƒ‡ãƒ«ã¯ GraphQL ã®å°å…¥ã«ä½œæˆã—ãŸã‚‚ã®ã«ã€TypeORM ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹å½¢ã§ä½œæˆã—ã¾ã™ã€‚
`books/book.ts` ã‚’ç·¨é›†ã—ã¾ã™ã€‚

```diff ts:src/books/book.ts
import { Field, ID, Int, ObjectType } from '@nestjs/graphql';
import {
  Entity,
  Column,
  PrimaryGeneratedColumn,
  CreateDateColumn,
} from 'typeorm';

@Entity()
@ObjectType()
export class Book {
  @PrimaryGeneratedColumn()
  @Field((type) => ID)
  id: number;

  @Column({ length: '30' })
  @Field()
  title: string;

  @Column()
  @Field((type) => [String])
  author: string;

  @Column({ type: 'int', unsigned: true })
  @Field((type) => Int)
  price: number;

  @CreateDateColumn()
  @Field()
  createdAt: Date;
}

```

```diff ts:src/app.module.ts
import { Module } from '@nestjs/common';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { GraphQLModule } from '@nestjs/graphql';
import { join } from 'path';
import { BooksModule } from './books/books.module';
import { TypeOrmModule } from '@nestjs/typeorm';
+ import { Book } from './books/book';

@Module({
  imports: [
    GraphQLModule.forRoot({
      autoSchemaFile: join(process.cwd(), 'src/schema.gql'),
    }),
    TypeOrmModule.forRoot({
      type: 'mysql',
      host: 'localhost',
      port: 3306,
      username: 'root',
      password: '',
      database: 'nest_sample_app',
-       entities: [],
+       entities: [Book],
      synchronize: true,
    }),
    BooksModule,
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

ã•ã‚‰ã«ã€`books/books.module.ts` ã‚‚ä¿®æ­£ã—ã¾ã™ã€‚

```diff ts:src/books/books.module.ts
import { Module } from '@nestjs/common';
import { BooksService } from './books.service';
import { BooksResolver } from './books.resolver';
import { TypeOrmModule } from '@nestjs/typeorm';
+ import { Book } from './book';

@Module({
 +  imports: [TypeOrmModule.forFeature([Book])],
  providers: [BooksService, BooksResolver],
})
export class BooksModule {}
```

## ã‚µãƒ¼ãƒ“ã‚¹ã®ä¿®æ­£

ãƒ¢ãƒ‡ãƒ«ã®æº–å‚™ãŒå®Œäº†ã—ãŸã®ã§ã€ã‚µãƒ¼ãƒ“ã‚¹ã®å‡¦ç†ã‚’ç½®ãæ›ãˆã¦ã„ãã¾ã™ã€‚

```ts:src/books/books.service.ts
import { Injectable } from '@nestjs/common';
import { Book } from './book';
import { newBookInput } from './dto/newBook.input';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';

@Injectable()
export class BooksService {
  constructor(
    @InjectRepository(Book)
    private booksRepostiory: Repository<Book>,
  ) {}

  findAll(): Promise<Book[]> {
    return this.booksRepostiory.find();
  }

  findOneById(id: number): Promise<Book> {
    return this.booksRepostiory.findOne(id);
  }

  async create(data: newBookInput): Promise<Book> {
    const book = this.booksRepostiory.create(data);
    await this.booksRepostiory.save(book);
    return book;
  }

  async remove(id: number): Promise<boolean> {
    const result = await this.booksRepostiory.delete(id);
    return result.affected > 0;
  }
}
```

TypeORM ã¯ãƒ¬ãƒã‚¸ãƒˆãƒªãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚
`InjectRepository` ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã§ booksRepository ã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã—ã¾ã™ã€‚

å„ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ `booksRepository` ã‚’ä½¿ã£ãŸã‚‚ã®ã«ç½®ãæ›ãˆã¦ã„ã¾ã™ã€‚

ãã‚Œã§ã¯å®Ÿéš›ã«å‹•ä½œã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

http://localhost:3000/graphqlã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€GraphQLãƒ—ãƒ¬ã‚¤ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§`addBook`ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/ezbjqp0g3qqmoznovz7k7zpvys8s)

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç¢ºèªã—ã¾ã™ã€‚

```sh
mysql> use nest_sample_app;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql> show tables;
+---------------------------+
| Tables_in_nest_sample_app |
+---------------------------+
| book                      |
+---------------------------+
1 row in set (0.01 sec)
```

`nset_sample_app` ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã« `book` ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚
ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚‚ç¢ºèªã—ã¾ã™ã€‚

```sh

mysql> select * from book;
+----+-------+----------------------------+-------+--------+
| id | price | createdAt                  | title | author |
+----+-------+----------------------------+-------+--------+
|  2 |  2011 | 2021-03-13 13:52:27.807220 | test  | Alice  |
+----+-------+----------------------------+-------+--------+
1 row in set (0.03 sec)
```

ã•ãã»ã© GraphQL ã§è¿½åŠ ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚

GraphQL ãƒ—ãƒ¬ã‚¤ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«æˆ»ã‚Šã€`books` ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¾ã—ã‚‡ã†ã€‚

![](https://storage.googleapis.com/zenn-user-upload/vzvi02onqc224kgr1wuo6sc7k0bj)

ã¾ã•ã—ããƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å€¤ãŒå–å¾—ã§ãã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

# çµ‚ã‚ã‚Šã«

Nest.js ã¨ TypeORM ã‚’ç”¨ã„ãŸç°¡å˜ãª GraphQL ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚
ã™ã¹ã¦ã®ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã‹ã‚‰å‚ç…§ã§ãã¾ã™ã€‚

https://github.com/azukiazusa1/nest-sample-app
