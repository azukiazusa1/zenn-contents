---
title: "Deno ã§REST API"
emoji: "ğŸ¦–"
type: "tech"
topics: ["mongodb", "typescript", "deno"]
published: true
---

ã“ã®è¨˜äº‹ã§ã¯ã€Denoã‚’ä½¿ã„ç°¡å˜ãªCRUDæ“ä½œã‚’è¡Œã†REST APIã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

# ç’°å¢ƒæ§‹ç¯‰

## Denoã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ã¯ã˜ã‚ã«Denoã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ã¯ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
https://deno.land/#installation

ã‚ˆãä½¿ã„ãã†ãªæ–¹æ³•ã‚’ã„ãã¤ã‹è¨˜è¼‰ã—ã¦ãŠãã¾ã™ã€‚

### Shell (Mac, Linux):

```sh
curl -fsSL https://deno.land/x/install/install.sh | sh
```

### PowerShell (Windows):

```sh
iwr https://deno.land/x/install/install.ps1 -useb | iex
```

### Homebrew (Mac):

```sh
brew install deno
```

ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¾ã™ã€‚

```sh
deno --version
deno 1.7.5 (release, x86_64-apple-darwin)
v8 9.0.123
typescript 4.1.4
```

## VSCodeã®æ‹¡å¼µã®å°å…¥

ä»¥ä¸‹ã®æ‹¡å¼µã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
https://marketplace.visualstudio.com/items?itemName=denoland.vscode-deno
ï¼ˆã“ã‚Œã‚’å…¥ã‚Œãªã„ã¨å‹ãŒå…¨ãåŠ¹ãã¾ã›ã‚“ãƒ»ãƒ»ãƒ»ï¼‰

æ‹¡å¼µã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã‚‰ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§`Ctrl+Shift+P`ã§ã‚³ãƒãƒ³ãƒ‰ãƒ‘ãƒ¬ãƒƒãƒˆã‚’é–‹ãã€`Deno Initialize Workspace Configuration`ã‚’é¸æŠã—ã¾ã™ã€‚

ã„ãã¤ã‹å¯¾è©±å½¢å¼ã§é¸æŠè‚¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ãŒã€ã™ã¹ã¦Yesã§å¤§ä¸ˆå¤«ã§ã™ã€‚
å®Œäº†ã—ãŸã‚‰ã€`.vscode/setting.json`ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™ã€‚

```json:.vscode/setting.json
{
  "deno.enable": true,
  "deno.lint": true,
  "deno.unstable": true
}
```

APIã‚’å©ããŸã‚ã«ã€ä¸‹è¨˜æ‹¡å¼µã‚‚ä½¿ç”¨ã—ã¾ã™ã€‚

https://marketplace.visualstudio.com/items?itemName=humao.rest-client


curlã‚„Postmanãªã©ãŒå¥½ããªãƒ„ãƒ¼ãƒ«ã§ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚

# ã‚µãƒ¼ãƒãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

ã¾ãšã¯ç°¡å˜ãª`Hello World!`ã‚’è¿”ã™ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚
ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«`src`ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ãã®ä¸­ã«`server.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```ts:src/server.ts
import { Application, Router, RouterContext } from "https://deno.land/x/oak@v6.5.0/mod.ts";

const app = new Application();
const router = new Router();

app.addEventListener("listen", ({ hostname, port, secure }) => {
  console.log(
    `Listening on: ${secure ? "https://" : "http://"}${hostname ??
      "localhost"}:${port}`,
  );
});

app.addEventListener("error", (evt) => {
  console.log(evt.error);
});

router.get('/', (ctx: RouterContext) => {
  ctx.response.body = "Hello World!";
})

app.use(router.routes());
app.use(router.allowedMethods());

await app.listen({ port: 8080 });
```

ã‚µãƒ¼ãƒãƒ¼ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«ã¯Orkã‚’ä½¿ã„ã¾ã™ã€‚

https://github.com/oakserver/oak

Orkã¯ã€[Koa](https://github.com/koajs/koa/)ã«å½±éŸ¿ã‚’å—ã‘ã¦ã„ã¾ã™ã€‚

Denoã§ã¯ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯URLã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ã“ã®ã¨ãã€`oak@v6.5.0`ã®ã‚ˆã†ã«æ˜ç¤ºçš„ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹ã®ãŒã‚ˆã„ã§ã—ã‚‡ã†ã€‚

`Application`ã‚¯ãƒ©ã‚¹ã¯ã€`http`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®`serve()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ãƒ©ãƒƒãƒ—ã—ãŸã‚‚ã®ã§ã™ã€‚ã“ã‚Œã¯`use()`ãƒ¡ã‚½ãƒƒãƒ‰ã¨`listen()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒã£ã¦ã„ã¾ã™ã€‚
`use()`ãƒ¡ã‚½ãƒƒãƒ‰ã¯ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®ç™»éŒ²ã‚’ã€`listen()`ã¯ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ã—ã¾ã™ã€‚

ã¾ãŸã€`Application`ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯`.addEventListener()`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’è³¼èª­ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
`listen`ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ãŸéš›ã«å‘¼ã³å‡ºã•ã‚Œã€`error`ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚µãƒ¼ãƒãƒ¼ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸéš›ã«å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚

`Router`ã‚¯ãƒ©ã‚¹ã¯ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚

ç¬¬ä¸€å¼•æ•°ã«ã¯ãƒ«ãƒ¼ãƒˆã®ãƒ‘ã‚¹åã‚’å—ã‘å–ã‚Šã€ç¬¬äºŒå¼•æ•°ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚

ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã®å¼•æ•°ã«ã¯[Context](https://github.com/oakserver/oak#context)ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ¸¡ã•ã‚Œã¾ã™ã€‚

ã“ã®ç°¡å˜ãªä¾‹ã§ã¯ã€`ctx.response.body`ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã«`Hello World!`ã¨ã„ã†æ–‡å­—åˆ—ã‚’ä»£å…¥ã™ã‚‹ã“ã¨ã§`Hello World!`ã¨è¿”ã™ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚Denoã‚’å®Ÿè¡Œã™ã‚‹éš›ã«ã€`--allow-net`ãƒ•ãƒ©ã‚°ã‚’ä»˜ä¸ã—ã¦ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ä¸ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```sh
deno run --allow-net server.ts
```

APIã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚
`request.http`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```http:request.http
### echo Hello World!
http://localhost:8080
```

`Send Request`ã¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã®ã§ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
ãƒ¬ã‚¹ãƒãƒ³ã‚¹çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

![hello-world-response](//images.ctfassets.net/in6v9lxmm5c8/5PuD6vadJY82w4R2cTFARy/a820ab29b13fc855c1f55f673978343d/____________________________2021-02-27_23.02.06.png)

ã—ã£ã‹ã‚Šã¨`Hello World!`ã¨ã„ã†æ–‡å­—åˆ—ãŒè¿”ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

# denonã®å°å…¥

ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ãŸã®ã§ã“ã“ã‹ã‚‰ã©ã‚“ã©ã‚“å®Ÿè£…ã—ã¦ã„ããŸã„ã¨ã“ã‚ã§ã™ãŒã€ä»Šã®çŠ¶æ…‹ã§ã™ã¨å¤‰æ›´ãŒã‚ã‚‹åº¦ã«æ‰‹å‹•ã§ã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•ã—ãªã‘ã‚Œã°ã„ã‘ã¾ã›ã‚“ã€‚

ãã‚Œã§ã¯é¢å€’ã§ã™ã®ã§ã€denonã¨å‘¼ã°ã‚Œã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

https://deno.land/x/denon@2.4.7

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```sh
deno install -qAf --unstable https://deno.land/x/denon/denon.ts
```

:::message
ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«ã¯denoã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³1.4.0ä»¥ä¸ŠãŒå¿…è¦ã§ã™ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ãŸäººã¯ã€`deno upgrade`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã¿ã¦ãã ã•ã„ã€‚
:::


## ãƒ‘ã‚¹ã‚’é€šã™

bashã§å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãƒ‘ã‚¹ã‚’é€šã—ã¾ã™ã€‚
(Macã®å ´åˆã§ã™ï¼‰

```sh
echo 'export PATH="$HOME/.deno/bin:$PATH"' >> ~/.bash_profile
source ~/.bash_profile
```

## è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆ

ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯å¿…é ˆã§ã¯ãªã„ã§ã™ãŒã€ç”Ÿæˆã—ã¦ãŠãã¨æ¯å›é•·ã„ãƒ•ãƒ©ã‚°ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã—ãªãã¦ã‚‚ã‚ˆããªã‚Šã¾ã™ã€‚`npm-scripts`ã«è¿‘ã„ã‚ˆã†ãªã‚‚ã®ã§ã™ã€‚

```sh
denon --init typescript
```

è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ã‚‚ã®ãŒã“ã¡ã‚‰ã§ã™ã€‚

```ts:scripts.config.ts
import { DenonConfig } from "https://deno.land/x/denon@2.4.7/mod.ts";

const config: DenonConfig = {
  scripts: {
    start: {
      cmd: "deno run app.ts",
      desc: "run my app.ts file",
    },
  },
};

export default config;
```

ãƒ•ãƒ©ã‚°ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹ãªã©ã®ä¿®æ­£ã‚’è¡Œã„ã¾ã™ã€‚

```diff ts:scripts.config.ts

import { DenonConfig } from "https://deno.land/x/denon@2.4.7/mod.ts";

const config: DenonConfig = {
  scripts: {
    start: {
-      cmd: "deno run app.ts",
-      desc: "run my app.ts file",
+      cmd: "deno run src/server.ts",
+      desc: "run my server.ts file",
+      allow: ["net"],
+      unstable: true,
    },
  },
};

export default config;
```

ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œã—ã¾ã™ã€‚

```sh
denon start
```

ã“ã‚Œã§å¤‰æ›´ã‚’åŠ ãˆã‚‹åº¦ã«è‡ªå‹•ã§ã‚µãƒ¼ãƒãƒ¼ãŒå†èµ·å‹•ã—ã¦ãã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

# ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ä½œæˆ

APIç”¨ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¿½åŠ ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚
`src/router.ts`ã‚’ä½œæˆã—ã¦ãã“ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¨˜è¿°ã—ã¦ã„ãã¾ã™ã€‚

```ts:src/router.ts
import { Router } from "https://deno.land/x/oak@v6.5.0/mod.ts";

const router = new Router();

router.get('/api/v1/books', () => {})
router.get('/api/v1/books/:id', () => {})
router.post('/api/v1/books', () => {})
router.put('/api/v1/books/:id', () => {})
router.delete('/api/v1/books/:id', () => {})

export { router }
```

`server.ts`ã§ã¯ã€`router.ts`ã‹ã‚‰`router`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ä½¿ç”¨ã—ã¾ã™ã€‚

```diff ts:src/server.ts
- import { Application, Router, RouterContext } from "https://deno.land/x/oak@v6.5.0/mod.ts";
+ import { Application } from "https://deno.land/x/oak@v6.5.0/mod.ts";
+ import { router } from './router.ts'

const app = new Application();
- const router = new Router();

app.addEventListener("listen", ({ hostname, port, secure }) => {
  console.log(
    `Listening on: ${secure ? "https://" : "http://"}${hostname ??
      "localhost"}:${port}`,
  );
});

app.addEventListener("error", (evt) => {
  console.log(evt.error);
});

- router.get('/', (ctx: RouterContext) => {
-   ctx.response.body = "Hello World!";
- })

app.use(router.routes());
app.use(router.allowedMethods());

await app.listen({ port: 8080 });
```

# ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®ä½œæˆ

ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®å®Ÿéš›ã®å‡¦ç†ã¯ç›´æ¥ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¨˜è¿°ã™ã‚‹ã®ã§ã¯ãªãã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã«ä»»ã›ã¾ã™ã€‚

`src/controllers`ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¦ã€`booksController.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```ts:src/controllers/booksController.ts
import { RouterContext, helpers } from "https://deno.land/x/oak@v6.5.0/mod.ts";

export const booksController = {
  getAll(ctx: RouterContext) {
    ctx.response.body = 'Get All Books'
  },

  get(ctx: RouterContext) {
    const { id } = helpers.getQuery(ctx, { mergeParams: true });
    ctx.response.body = `Get Book By ID: ${id}`
  },

  create(ctx: RouterContext) {
    ctx.response.body = 'Create Book'
  },

  update(ctx: RouterContext) {
    const { id } = helpers.getQuery(ctx, { mergeParams: true });
    ctx.response.body = `Update Book By ID: ${id}`
  },

  delete(ctx: RouterContext) {
    const { id } = helpers.getQuery(ctx, { mergeParams: true });
    ctx.response.body = `Delete Book By ID: ${id}`
  }
}
```

`router.ts`ã«ãŠã„ã¦ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®å‡¦ç†ã¨å¯¾å¿œã•ã›ã¾ã™ã€‚

```ts:src/rotuer.ts
import { Router } from "https://deno.land/x/oak@v6.5.0/mod.ts";
import { booksController } from './controllers/booksController.ts'
const router = new Router();

router.get('/api/v1/books', booksController.getAll)
router.get('/api/v1/books/:id', booksController.get)
router.post('/api/v1/books', booksController.create)
router.put('/api/v1/books/:id', booksController.update)
router.delete('/api/v1/books/:id', booksController.delete)

export { router }
```

ã“ã“ã¾ã§å®Œäº†ã—ãŸã‚‰ã€APIã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
`request.http`ã‚’ç·¨é›†ã—ã¾ã™ã€‚

```http:request.http
### echo Hello World!
GET http://localhost:8080

### Get All Books
GET http://localhost:8080/api/v1/books

### Get Books by ID
GET http://localhost:8080/api/v1/books/1

### Create Book
POST http://localhost:8080/api/v1/books
Content-Type: application/json

### Update Book By Id
PUT http://localhost:8080/api/v1/books/1
Content-Type: application/json

### Delete Book By ID
DELETE http://localhost:8080/api/v1/books/1
```

ãã‚Œãã‚Œã®ãƒ«ãƒ¼ãƒˆã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã€æ­£ã—ããƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒå¸°ã£ã¦ãã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã¿ã¦ãã ã•ã„ã€‚

# MongoDBã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®å®Ÿè£…ã«å…¥ã‚‹å‰ã«ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¾ã™ã€‚
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã¯MongoDBã‚’åˆ©ç”¨ã—ã¾ã™ã€‚MondoDBã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‹ã®NoSQLã§ã‚ã‚Šã€JSONã®æ§‹é€ ã‚’ãã®ã¾ã¾ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä¿å­˜ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## MondoDBã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

### Mac

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€MongoDBã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
ã“ã“ã§ã¯Homebrewã‚’ä½¿ç”¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™ã€‚

```sh
brew tap mongodb/brew
brew install mongodb-community@4.2
```

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§èµ·å‹•ã—ã¾ã™ã€‚

```sh
brew services start mongodb-community@4.2
```

### Window

ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚ç…§ãŠé¡˜ã„ã—ã¾ã™ã€‚

[windows10ã«mongoDBã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹](https://mebee.info/2019/11/27/post-3520/)

## deno_mongoã®è¨­å®š

deno_mongoã¯ã€Denoã®MongoDBã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã§ã™ã€‚

https://deno.land/x/mongo@v0.21.2

`src`ãƒ•ã‚©ãƒ«ãƒ€ã«`db.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```ts: src/db.ts
import { MongoClient } from "https://deno.land/x/mongo@v0.21.0/mod.ts";

const client = new MongoClient();
await client.connect("mongodb://127.0.0.1:27017");

export const db = client.database("deno_rest_api");
```

æ¥ç¶šå…ˆã¯å„è‡ªã®ç’°å¢ƒã«åˆã‚ã›ã¦ãã ã•ã„ã€‚

å…¬å¼ã®READMEã«ã¯`mongodb://localhost:27017`ã¨è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ãŒã€localhostã‚’æŒ‡å®šã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§`mongodb://127.0.0.1:27017`ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚

## envã®å°å…¥

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æ¥ç¶šå…ˆã¯ã€ã‚»ã‚­ãƒ¥ã‚¢ãªå±æ€§ã§ã‚‚ã‚ã‚Šã¾ã™ã®ã§ã€`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã“ã‹ã‚‰èª­ã¿å–ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```.env
MONGO_URI=mongodb://localhost:27017
```

`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿å–ã‚‹ãŸã‚ã«Dotenvãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

https://deno.land/x/dotenv@v2.0.0

`db.ts`ã‚’ä¿®æ­£ã—ã¾ã™ã€‚

```diff:src/db.ts
import { MongoClient } from "https://deno.land/x/mongo@v0.21.0/mod.ts";
+ import "https://deno.land/x/dotenv@v2.0.0/load.ts";

const client = new MongoClient();
- await client.connect("mongodb://127.0.0.1:27017");
+ await client.connect(Deno.env.get('MONGO_URI')!);

export const db = client.database("deno_rest_api");
```

ã•ã‚‰ã«ã€Deno`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿å–ã‚‹ãŸã‚ã«ã¯`--allow-env`ãƒ•ãƒ©ã‚°ã¨`--allow-read`ãƒ•ãƒ©ã‚°ã‚’ä»˜ä¸ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
`scripts.config.ts`ã‚’ä¿®æ­£ã—ã¾ã—ã‚‡ã†ã€‚

```diff ts:scripts.config.ts

import { DenonConfig } from "https://deno.land/x/denon@2.4.7/mod.ts";

const config: DenonConfig = {
  scripts: {
    start: {
      cmd: "deno run src/server.ts",
      desc: "run my server.ts file",
-       allow: ["net"],
+       allow: ["net", "read", "env"],
      unstable: true,
    },
  },
};

export default config;
```

`scripts.config.ts`ã‚’ä¿®æ­£ã—ãŸã‚‰ã€`Ctrl + c`ã§ä¸€æ—¦denonãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†ã—å†åº¦èµ·å‹•ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

# ãƒ¢ãƒ‡ãƒ«ã®ä½œæˆ

MongoDBã«æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ã—ãŸã®ã§ã€DBã¨ã®ã‚„ã‚Šå–ã‚Šã‚’è¡Œã†ãŸã‚ã®ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

`src/models`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€`Books.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```ts: src/models/Books.ts
import { db } from "../db.ts";

interface BookSchema {
  _id: { $oid: string };
  title: string;
  author: string;
  price: number
}

const booksCollection = db.collection<BookSchema>("books");

type Payload = Pick<BookSchema, 'title' | 'author' | 'price'>

export class Book {

  private constructor(
    public title: string,
    public author: string,
    public price: number,
    public _id: object | undefined = undefined,
  ) {}

  static findAll() {
  }

  static async findById(id: string) {
  }
  
  static create({ title, author, price }: Payload) {
    return new this(title, author, price)
  }

  async save() {
  }

  async update() {
  }

  static async delete() {

  }
}
```

# ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®å®Ÿè£…

## createã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å®Ÿè£…

ãã‚Œã§ã¯ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®å®Ÿè£…ã«å…¥ã‚Šã¾ã™ã€‚ã¾ãšã¯ã€createã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

```ts:src/controller.ts
import { RouterContext, helpers } from "https://deno.land/x/oak@v6.5.0/mod.ts";
import { Book } from '../models/Book.ts'

// çœç•¥

  async create(ctx: RouterContext) {
    const result = ctx.request.body()
    const { title, author, price }  = await result.value
    const book = await Book.create({
      title,
      author,
      price: Number(price)
    });

    await book.save()
    ctx.response.body = book
  },
```

`request.body()`ã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’å–å¾—ã—ã¦ã€`result.value`ã§å€¤ã‚’å–å¾—ã—ã¾ã™ã€‚
`result.value`ã¯`Promise`ã‚’è¿”ã—ã¾ã™ã®ã§`await`ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãƒ¢ãƒ‡ãƒ«ã®`save()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚‚å®Ÿè£…ã—ã¾ã—ã‚‡ã†ã€‚

```ts:src/models/Book.ts
export class Book {
  // çœç•¥
  async save() {
    const _id = await booksCollection.insertOne({
      title: this.title,
      author: this.author,
      price: this.price
    })

    this._id = _id
  }
}
```

ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®`insertOne()`ãƒ¡ã‚½ãƒƒãƒ‰ã§ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒ‡å®šã—ã¦æŒ¿å…¥ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

`request.http`ã‹ã‚‰POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```http:request.http
### Create Book
POST http://localhost:8080/api/v1/books
Content-Type: application/json

{
  "title": "test book",
  "author": "Alice",
  "price": 1000
}
```

æ¬¡ã®ã‚ˆã†ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”å´ã•ã‚Œã¾ã™ã€‚

```
HTTP/1.1 200 OK
content-length: 83
content-type: application/json; charset=utf-8

{
  "title": "test book",
  "author": "Alice",
  "price": 1000,
  "_id": "603b0164087250327b35addb"
}
```

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ‡ãƒ¼ã‚¿ãŒæŒ¿å…¥ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã‚Šå¯¾è©±å½¢å¼ã§MongoDBã‚’æ“ä½œã§ãã¾ã™ã€‚

```sh
mongo
```

`use [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å]`ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚ä»Šå›ã¯`deno_rest_api`ã¨ã„ã†ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åã§ä½œæˆã—ã¦ã„ã¾ã™ã€‚
(`db.ts`ã«ãŠã„ã¦ã€`client.database()`ã«æŒ‡å®šã—ãŸåå‰ã§ã™)

```sh
> use deno_rest_api
switched to db deno_rest_api
```

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’å‚ç…§ã™ã‚‹ã«ã¯ã€`db.[ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å].find();`ã¨ã„ã†ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³åã¯`books`ã§ã™ã€‚
(`models/Book.ts`ã«ãŠã„ã¦`db.collection<T>()`ã§æŒ‡å®šã—ãŸåå‰ã§ã™ï¼‰

```sh
> db.books.find()
{ "_id" : ObjectId("603b0164087250327b35addb"), "title" : "test book", "author" : "Alice", "price" : 1000 }
```

ãƒ‡ãƒ¼ã‚¿ãŒæŒ¿å…¥ã•ã‚Œã‚Œã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚
ä½•ä»¶ã‹ä»–ã®ãƒ‡ãƒ¼ã‚¿ã‚‚ä½œæˆã—ã¦ã¿ã‚‹ã¨è‰¯ã„ã§ã—ã‚‡ã†ã€‚

## getAllã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å®Ÿè£…

ç¶šã„ã¦ã„getAllã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã—ã¾ã™ã€‚ã“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯booksã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å…¨ã¦ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¿”ã™ã‚ˆã†ã«ã—ã¾ã™ã€‚

```ts:src/controllers/booksController.ts
  async getAll(ctx: RouterContext) {
    const books = await Book.findAll()
    ctx.response.body = books
  },
```

ãƒ¢ãƒ‡ãƒ«ã®`findAll()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```ts:src/models/Book.ts
export class Book {
  // çœç•¥
  static async findAll() {
    const books = await booksCollection.find().toArray()
    return books.map(book => {
      return new this(
        book.title, 
        book.author,
        book.price,
        book._id
      )
    })
  }
}
```


ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèªã—ã¾ã™ã€‚

```
HTTP/1.1 200 OK
content-length: 354
content-type: application/json; charset=utf-8

[
  {
    "_id": "603b0164087250327b35addb",
    "title": "test book",
    "author": "Alice",
    "price": 1000
  },
  {
    "_id": "603b037a087250327b35addc",
    "title": "test book2",
    "author": "Bob",
    "price": 600
  },
  {
    "_id": "603b03a9087250327b35addd",
    "title": "test book3",
    "author": "Joe",
    "price": 1200
  },
]
```

## getã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å®Ÿè£…

getã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€IDã‚’æŒ‡å®šã—ã¦ç‰¹å®šã®bookã‚’å–å¾—ã—ã¾ã™ã€‚
IDã¯å‹•çš„ãƒ‘ã‚¹`:id`ã‹ã‚‰å–å¾—ã—ã¾ã™ã€‚

ã“ã‚Œã¯`context.params.id`ã§ã‚‚å–å¾—ã§ãã¾ã™ãŒã€`helpers.getQuery()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã†ã¨ã‚ˆã—ãªã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§å–å¾—ã§ãã¾ã™ã€‚

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå–å¾—ã§ããªã‹ã£ãŸå ´åˆã«ã¯404ã‚’è¿”ã™ã‚ˆã†ã«ã—ã¾ã™ã€‚

```ts:src/controllers/booksController.ts
  async get(ctx: RouterContext) {
    const { id } = helpers.getQuery(ctx, { mergeParams: true });
    const book = await Book.findById(id)
  
    if (!book) {
      ctx.response.status = 404
      ctx.response.body = { message: "Not found." }
    } else {
      ctx.response.body = book
    }
  },
```

ãƒ¢ãƒ‡ãƒ«ã®`findById()`ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…ã§ã™ã€‚

```ts:src/models/Book.ts
import { Bson } from "https://deno.land/x/mongo@v0.21.0/mod.ts"; // ã“ã‚Œã‚’è¿½åŠ 

// çœç•¥

export class Book {
  // çœç•¥
  static async findById(id: string) {
    const book = await booksCollection.findOne({ _id: new Bson.ObjectId(id) })
    if (!book) return null
    
    return new this(
        book.title, 
        book.author,
        book.price,
        book._id
      )
  }
}  
```

MongoDBã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆIDã§å–å¾—ã™ã‚‹éš›ã«ã¯ã€æ–‡å­—åˆ—ã§æ¸¡ã•ã‚ŒãŸ`id`ã‚’`mongo`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®`Bson`ã«ã‚ˆã£ã¦å¤‰æ›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

IDã‚’æŒ‡å®šã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ã‚‡ã†ã€‚

```
### Get Books by ID
GET http://localhost:8080/api/v1/books/603b0164087250327b35addb
```

```
HTTP/1.1 200 OK
content-length: 84
content-type: application/json; charset=utf-8

{
  "_id": "603b0164087250327b35addb",
  "title": "test book",
  "author": "Alice",
  "price": 1000
}
```

## updateã‚¢ã‚¯ã‚·ãƒ§ãƒ³

ç¶šã„ã¦updateã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
`findById()`ã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ã—ã¦ã‹ã‚‰`update`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å–å¾—ã¯createã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¨åŒæ§˜ã§ã™ã€‚

```ts: src/controllers.ts
  async update(ctx: RouterContext) {
    const { id } = helpers.getQuery(ctx, { mergeParams: true });
    const book = await Book.findById(id)
  
    if (!book) {
      ctx.response.status = 404
      ctx.response.body = { message: "Not found." }
    } else {
      const result = ctx.request.body()
      const { title, author, price }  = await result.value
      await book.update({ title, author, price })
      ctx.response.body = book
    }
  },
```

ãƒ¢ãƒ‡ãƒ«ã®`update`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚

```ts: src/models/Book.ts
export class Book {
  // çœç•¥
  async update({ title, author, price }: Payload) {
    await booksCollection.updateOne(
      { _id: this?._id },
      { $set: { title, author, price } }
    );

    this.title = title
    this.author = author
    this.price = price
  }
}
```

ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®`updateOne()`ãƒ¡ã‚½ãƒƒãƒ‰ã¯ç¬¬ä¸€å¼•æ•°ã«ã‚¯ã‚¨ãƒªã®æ¡ä»¶ã‚’æŒ‡å®šã—ã¦ã€ç¬¬äºŒå¼•æ•°ã«ã‚»ãƒƒãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã—ã¾ã™ã€‚

ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```
### Update Book By Id
PUT http://localhost:8080/api/v1/books/603b0164087250327b35addb
Content-Type: application/json

{
  "title": "update book1",
  "author": "Joe",
  "price": 1200
}
```

```
HTTP/1.1 200 OK
content-length: 85
content-type: application/json; charset=utf-8

{
  "title": "update book1",
  "author": "Joe",
  "price": 1200,
  "_id": "603b0164087250327b35addb"
}
```

## deleteã‚¢ã‚¯ã‚·ãƒ§ãƒ³

æœ€å¾Œã«deleteã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚

```ts:src/controllers/booksController.ts
  async delete(ctx: RouterContext) {
    const { id } = helpers.getQuery(ctx, { mergeParams: true });
    await Book.delete(id)

    ctx.response.status = 204
  }
```

ãƒ¢ãƒ‡ãƒ«ã®`delete()`ãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè£…ã§ã™ã€‚

```ts:src/models/Book.ts

export class Book {
  // çœç•¥
  static delete(id: string) {
    booksCollection.deleteOne({ _id: new Bson.ObjectId(id) });
  }
}
```

ãƒ†ã‚¹ãƒˆã—ã¦ã¿ã¾ã™ã€‚

```
### Delete Book By ID
DELETE http://localhost:8080/api/v1/books/603b0164087250327b35addb
```

```
HTTP/1.1 204 No Content
content-length: 0
```

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä¸­èº«ã‚‚ç¢ºèªã—ã¦ã¿ã¦ãã ã•ã„ã€‚

# çµ‚ã‚ã‚Šã«

ç°¡å˜ãªREST APIã‚’Denoã§ä½œæˆã—ã¦ã¿ã¾ã—ãŸã€‚

ã™ã¹ã¦ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚

https://github.com/azukiazusa1/deno-rest-api

ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚‚æƒã£ã¦ã„ãŸç‰¹ã«å›°ã‚‹ã“ã¨ãŒãªãå®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚
ã¨ã¯ã„ãˆã€`unstatable`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã¾ã æ™‚æœŸå°šæ—©ã¨ã„ã£ãŸã¨ã“ã‚ã§ã—ã‚‡ã†ã‹ã€‚